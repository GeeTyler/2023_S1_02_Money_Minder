@layout MainLayout
@page "/bankaccounts/{Text}"
@using MoneyMinder.Model
@using MoneyMinder.Data
@using MoneyMinder.Pages
@using Microsoft.AspNetCore.Identity;
@inject IDataAccessService DataAccessService
@inject NavigationManager NavManager
@inject UserManager<IdentityUser> _userManager
@inject SignInManager<IdentityUser> SignInManager


<AuthorizeView>
    <Authorized>
        <div class="account_info_container">
            <div class="account_number_container">
                <p class="account_number">Account Number: @ConvertAccountNumToString(CurrentBankAccount.AccountNum)</p>

                <label class="transaction_label" for="">
                    @if (CurrentBankAccount.Blocked == true)
                    {
                        <p style="color: #D20202;">Transaction blocked</p>
                    }
                    else
                    {
                        <p style="color: #02D20A;">Block further transaction</p>
                    }
                    <input class="transaction" type="checkbox" @onclick="(e=>changedChecked())">
                </label>
            </div>
            <div class="container_with_transfer_btn">
                <div class="account_holder_name_container">
                    <p class="account_holder">Account Holder: @Current.FirstName @Current.LastName</p>
                    <div class="account_name">
                            <p>Account Name: @CurrentBankAccount.Name</p>
                    </div>
                </div>
                <div class="account_transfer_btn_container">
                    <button class="account_transfer_btn" @onclick="@(e=>clickedOnTransfer(CurrentBankAccount.Name))">Make Transfer</button>
                </div>
                <br />
                <div class="account_transfer_btn_container">
                    <button class="account_transfer_btn" @onclick="@GenerateTransaction">Random Transactions</button>
                </div>
            </div>
        </div>

        <div class="list_tab_container">
            <div class="list_tab">
                <div class="tab_btn tab_all" @onclick="AllClicked">All</div>
                <div class="tab_btn tab_necessary" @onclick="NecessaryClicked">Necessary</div>
                <div class="tab_btn tab_discretionary" @onclick="DiscretionaryClicked">Discretionary</div>
            </div>
            <p class="account_current_bal">$@String.Format("{0:N2}",CurrentBankAccount.Balance)</p>
        </div>

        <div class="account_content">
            <table class="account_content_table">
                <thead>
                    <tr>
                        <th class="table_date">Date</th>
                        <th class="table_balance">Transaction Number</th>
                        <th class="table_description">Transaction Type</th>
                        <th class="table_transaction">Amount</th>
                        <th class="table_percentage">Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!isDiscretionary && !isNecessary)
                    {
                        if (AccountsTransactions.Count > 0)
                        {
                            foreach (var item in AccountsTransactions)
                            {
                                <tr>
                                    <td>@item.DateandTime.ToShortDateString()</td>
                                    <td>@item.TrasactionNum</td>
                                    <td>@item.TransactionType</td>
                                    <td>$ @String.Format("{0:N2}",item.TransactionAmount)</td>
                                    <td>@String.Format("{0:N2}", PercentageOfTransactions("all",item.TransactionAmount))%</td>
                                </tr>
                            }
                        }
                    }
                    @if (isDiscretionary && !isNecessary)
                    {
                        foreach (var item in AccountsTransactions.Where(e => e.TransactionType.Equals("Shopping")
                        || e.TransactionType.Equals("Eating Out") || e.TransactionType.Equals("Entertainment")))
                        {
                            <tr>
                                <td>@item.DateandTime.ToShortDateString()</td>
                                <td>@item.TrasactionNum</td>
                                <td>@item.TransactionType</td>
                                <td>$ @String.Format("{0:N2}",item.TransactionAmount)</td>
                                <td>@String.Format("{0:N2}", PercentageOfTransactions("discretionary",item.TransactionAmount))%</td>
                            </tr>
                        }
                    }
                    @if (!isDiscretionary && isNecessary)
                    {
                        foreach (var item in AccountsTransactions.Where(e => e.TransactionType.Equals("Bills")
                        || e.TransactionType.Equals("Supermarket")))
                        {
                            <tr>
                                <td>@item.DateandTime.ToShortDateString()</td>
                                <td>@item.TrasactionNum</td>
                                <td>@item.TransactionType</td>
                                <td>$ @String.Format("{0:N2}",item.TransactionAmount)</td>
                                <td>@String.Format("{0:N2}", PercentageOfTransactions("necessary",item.TransactionAmount))%</td>
                            </tr>
                        }
                    }
                </tbody>
        </table>
        </div>
    </Authorized>
    <NotAuthorized>
        <p role="status">You are not authorised to see this component</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public string Text { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private User Current;
    private BankAccount CurrentBankAccount;
    private List<Transactions> AccountsTransactions;

    private double TotalAmount;

    async Task<string> getUsersEmail()
    {
        var user = (await authenticationStateTask).User;
        return user.Identity.Name;
    }

    protected override async Task OnInitializedAsync()
    {
        Current = DataAccessService.GetUser(await getUsersEmail());
        CurrentBankAccount = DataAccessService.GetBankAccount(Convert.ToInt32(Text));
        AccountsTransactions = DataAccessService.GetTransactions(CurrentBankAccount.AccountNum)
        .OrderByDescending(t => t.DateandTime).ToList();
        StateHasChanged();
    }

    private bool isChecked = false;
    private bool isClicked = false;
    private bool isNecessary = false;
    private bool isDiscretionary = false;

    public void clickedOnTransfer(string account)
    {
        NavManager.NavigateTo("/transfer/" + account);
    }

    private void changedChecked()
    {
        isChecked = !isChecked;
        DataAccessService.BlockBankAccount(CurrentBankAccount.AccountNum, isChecked);
        CurrentBankAccount = DataAccessService.GetBankAccount(Convert.ToInt32(Text));
        StateHasChanged();
    }

    public void GenerateTransaction()
    {
        DataAccessService.GenerateRandomTransactions(CurrentBankAccount.AccountNum);
        AccountsTransactions = DataAccessService.GetTransactions(CurrentBankAccount.AccountNum)
        .OrderByDescending(t => t.DateandTime).ToList();
        StateHasChanged();
    }

    private void changeClicked()
    {
        isClicked = !isClicked;
    }

    private void NecessaryClicked()
    {
        isDiscretionary = false;
        isNecessary = !isNecessary;
    }

    private void DiscretionaryClicked()
    {
        isDiscretionary = !isDiscretionary;
        isNecessary = false;
    }

    private void AllClicked()
    {
        isDiscretionary = false;
        isNecessary = false;
    }

    public string ConvertAccountNumToString(int AccountNum)
    {
        return string.Format("{0:###-###-###}", AccountNum);
    }

    public double PercentageOfTransactions(string type, double TransAmount)
    {
        double sum = 0;
        if (type == "all")
        {
            foreach (var item in AccountsTransactions)
            {
                sum += item.TransactionAmount;
            }
            TotalAmount = sum;
        }

        else if (type == "discretionary")
        {
            foreach (var item in AccountsTransactions.Where(e => e.TransactionType.Equals("Shopping") 
            || e.TransactionType.Equals("Eating Out") || e.TransactionType.Equals("Entertainment")))
            {
                sum += item.TransactionAmount;
            }
        }

        else if(type == "necessary")
        {
            foreach (var item in AccountsTransactions.Where(e => e.TransactionType.Equals("Bills") 
            || e.TransactionType.Equals("Supermarket")))
            {
                sum += item.TransactionAmount;
            }
        }
        return (TransAmount / sum) * 100;
    }
}
